
import numpy as np
import torch
import isaaclab.sim as sim_utils
import isaaclab.managers as mdp

from isaaclab.envs.manager_based_rl_env_cfg import ManagerBasedRLEnvCfg
from isaaclab.managers.scene_entity_cfg import SceneEntityCfg
from isaaclab.managers import (
    ObservationGroupCfg as ObsGroup,
    ObservationTermCfg as ObsTerm,
    RewardTermCfg as RewTerm,
    TerminationTermCfg as DoneTerm,
    EventTermCfg as EventTerm,
    ActionTermCfg,
)

from isaaclab.actuators import ImplicitActuatorCfg
from isaaclab.assets import AssetBaseCfg
from isaaclab.assets.articulation import ArticulationCfg
from isaaclab.scene import InteractiveSceneCfg
from isaaclab.utils import configclass

import isaaclab.sim as sim_utils
from isaaclab.assets import AssetBaseCfg
from isaaclab.envs import ManagerBasedRLEnvCfg
from isaaclab.managers import EventTermCfg as EventTerm
from isaaclab.managers import ObservationGroupCfg as ObsGroup
from isaaclab.managers import ObservationTermCfg as ObsTerm
from isaaclab.managers import RewardTermCfg as RewTerm
from isaaclab.managers import SceneEntityCfg
from isaaclab.managers import TerminationTermCfg as DoneTerm
from isaaclab.scene import InteractiveSceneCfg
from isaaclab.terrains import TerrainImporterCfg
from isaaclab.utils import configclass


from isaaclab.managers import ActionTermCfg
from isaaclab.utils import configclass
import isaaclab.sim as sim_utils
from isaaclab.assets import AssetBaseCfg
from isaaclab.envs import ManagerBasedRLEnvCfg
from isaaclab.managers import ActionTermCfg as ActionTerm
from isaaclab.managers import CurriculumTermCfg as CurrTerm
from isaaclab.managers import EventTermCfg as EventTerm
from isaaclab.managers import ObservationGroupCfg as ObsGroup
from isaaclab.managers import ObservationTermCfg as ObsTerm
from isaaclab.managers import RewardTermCfg as RewTerm
from isaaclab.managers import SceneEntityCfg
from isaaclab.managers import TerminationTermCfg as DoneTerm
from isaaclab.scene import InteractiveSceneCfg
from isaaclab.utils import configclass
from isaaclab.utils.noise import AdditiveUniformNoiseCfg as Unoise
from isaaclab.sim.spawners.from_files.from_files_cfg import GroundPlaneCfg

from isaaclab.envs.mdp.actions.actions_cfg import (
    JointPositionActionCfg,
    JointVelocityActionCfg,
    JointEffortActionCfg,
)

from isaaclab.envs.mdp.actions.actions_cfg import JointVelocityActionCfg


from isaaclab.envs.manager_based_rl_env_cfg import ManagerBasedRLEnvCfg
from isaaclab.utils.configclass import configclass


def reset_wheel_joints(env, **kwargs):
    asset_name = kwargs["asset_name"]
    position_range = kwargs["position_range"]
    velocity_range = kwargs["velocity_range"]

    robot = env.scene[asset_name]

    # randomize wheel joint positions
    low, high = position_range
    pos = torch.empty_like(robot.data.joint_pos).uniform_(low, high)
    robot.write_joint_state(joint_pos=pos)

    # randomize wheel joint velocities
    vlow, vhigh = velocity_range
    vel = torch.empty_like(robot.data.joint_vel).uniform_(vlow, vhigh)
    robot.write_joint_state(joint_vel=vel)

def reset_robot_base(env, **kwargs):
    asset_name = kwargs["asset_name"]
    position = kwargs["position"]
    orientation = kwargs["orientation"]

    robot = env.scene[asset_name]

    robot.write_root_pose(
        position=torch.tensor(position),
        orientation=torch.tensor(orientation)
    )

def forward_x_reward(env, asset_name="reeman_robot"):
    robot = env.scene[asset_name]
    return robot.data.root_pos_w[0,0]  # x position

def collision_penalty(env, asset_name="reeman_robot"):
    robot = env.scene[asset_name]
    forces = robot.root_physx_view.get_contact_force_tensor()[0]
    return float(torch.norm(forces, dim=-1).sum() > 0)

def wheel_positions(env, asset_name="reeman_robot"):
    """Return wheel joint positions."""
    # get indices for this asset's joints
    robot = env.scene[asset_name]
    wheel_joint_ids = robot.joint_ids  # or filter for wheel names if needed
    return env.joint_pos[:, wheel_joint_ids]


def wheel_velocities(env, asset_name="reeman_robot"):
    """Return wheel joint velocities."""
    robot = env.scene[asset_name]
    wheel_joint_ids = robot.joint_ids
    return env.joint_vel[:, wheel_joint_ids]


def base_linear_velocity(env, asset_name="reeman_robot"):
    """Return base linear velocity in world frame."""
    robot = env.scene[asset_name]
    return robot.data.root_lin_vel


def last_action_applied(env):
    """Return the previous actions sent to the robot."""
    # saved automatically by manager
    return env.actions

# ------------------------------------------------------------------------ #
# SCENE
# ------------------------------------------------------------------------ #


class ReemanSceneCfg(InteractiveSceneCfg):
    """Spawns ground, lighting & Reeman robot."""

    # Add these two lines
    num_envs: int = 1         # only one environment
    env_spacing: float = 1.0  # any positive value works if only 1 env

    reeman_robot = ArticulationCfg(
        prim_path="/World/Reeman",
        spawn=sim_utils.UsdFileCfg(
            usd_path="/home/dhruv/Downloads/purple_assy_urdf_test7_2/"
                     "purple_assy_urdf_test7/urdf/purple_new_backup/purple_new_backup.usd"
        ),
        actuators={
            "wheel_acts": ImplicitActuatorCfg(
                joint_names_expr=["left_wheel_joint", "right_wheel_joint"],
                stiffness=100.0,  # add default stiffness
                damping=1.0       # add default damping
            )
        }
    )

    ground = AssetBaseCfg(
        prim_path="/World/defaultGroundPlane",
        spawn=sim_utils.GroundPlaneCfg()
    )

    dome_light = AssetBaseCfg(
        prim_path="/World/Light",
        spawn=sim_utils.DomeLightCfg(intensity=3000.0, color=(0.75, 0.75, 0.75))
    )

@configclass
class ActionsCfg:
    wheel_vel: mdp.ActionTermCfg = JointVelocityActionCfg(
        asset_name="reeman_robot",
        joint_names=["left_wheel_joint", "right_wheel_joint"],
        scale=1.0
    )

@configclass
class ObservationsCfg:
    @configclass
    class Policy(ObsGroup):

        wheel_pos = ObsTerm(func= wheel_positions,
                        params={"asset_name": "reeman_robot"},
                        noise=Unoise(n_min=-0.01, n_max=0.01))

        wheel_vel = ObsTerm(func= wheel_velocities,
                        params={"asset_name": "reeman_robot"},
                        noise=Unoise(n_min=-0.01, n_max=0.01))

        base_vel = ObsTerm(func= base_linear_velocity,
                       params={"asset_name": "reeman_robot"})

    last_action = ObsTerm(func= last_action_applied)
    def __post_init__(self):
        self.enable_corruption = True
        self.concatenate_terms = True

    policy: Policy = Policy()


@configclass
class RewardsCfg:

    forward_reward = RewTerm(
        func=forward_x_reward,
        weight=1.0,
        params={}
    )

    '''
    collision_penalty = RewTerm(
        func=collision_penalty,
        weight=-5.0,
        params={}
    )

    '''
@configclass
class TerminationsCfg:
    timeout = DoneTerm(
        func=lambda env: env.episode_length_buf >= env.max_episode_length
    )

@configclass
class EventCfg:
    # Reset wheel joints with small random offsets
    reset_wheels = EventTerm(
        func=reset_wheel_joints,      # custom helper
        mode="reset",
        params={
            "asset_name": "reeman_robot",
            "position_range": (-0.1, 0.1),     # small variations
            "velocity_range": (0.0, 0.0)       # stop wheels
        }
    )

    # Reset robot base pose (position + orientation)
    reset_base = EventTerm(
        func=reset_robot_base,         # custom helper
        mode="reset",
        params={
            "asset_name": "reeman_robot",
            # spawn slightly above ground to prevent initial contact issues
            "position": [0.0, 0.0, 0.1],
            "orientation": [0.0, 0.0, 0.0, 1.0],   # quaternion: no rotation
        }
    )


@configclass
class ReemanEnvCfg(ManagerBasedRLEnvCfg):
    decimation: int = 2
    scene: ReemanSceneCfg = ReemanSceneCfg()
    observations: ObservationsCfg = ObservationsCfg()
    actions: ActionsCfg = ActionsCfg()
    rewards: RewardsCfg = RewardsCfg()
    terminations: TerminationsCfg = TerminationsCfg()
    events: EventCfg = EventCfg()
    episode_length_s: float = 30.0
    render_interval: int = 2 
    params = {"env_id": 0} 


def __post_init__(self):
        self.scene.num_envs = 1
        self.scene.env_spacing = 1.0
